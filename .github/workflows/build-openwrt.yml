#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: ImmortalWrt Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget curl cmake python3 python3-pip

    - name: Prepare environment
      run: |
        echo "开始准备编译环境..."
        [ ! -d immortalwrt-mt798x-24.10 ] && git clone https://github.com/padavanonly/immortalwrt-mt798x-24.10 --depth=1
        cd immortalwrt-mt798x-24-10

    - name: Update feeds
      run: |
        cd immortalwrt-mt798x-24-10
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 如果需要自定义配置，请在此处添加步骤
    # - name: Apply custom config
    #   run: cp your-config-file .config

    - name: Build firmware
      run: |
        cd immortalwrt-mt798x-24-10
        make defconfig
        make download -j$(nproc)
        make -j$(($(nproc) + 1)) V=s

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: firmware
        path: immortalwrt-mt798x-24-10/bin/targets/
        if-no-files-found: error
        retention-days: 5
